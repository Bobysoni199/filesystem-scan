trigger:
- main

pool:
  name: agent

stages:
- stage: Pull_Image
  displayName: Pull Docker Image
  jobs:
  - job: Pull
    steps:
    - script: |
        docker pull nginx:alpine
      displayName: Pull NGINX Image

- stage: Image_Scan
  displayName: Scan Docker Image
  dependsOn: Pull_Image
  condition: succeeded()
  jobs:
  - job: Scan
    steps:
    - script: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.4_Linux-64bit.deb
        sudo dpkg -i trivy_0.48.4_Linux-64bit.deb
      displayName: Install Trivy

    - script: |
        trivy image --severity HIGH,CRITICAL --exit-code 1 nginx:alpine
      displayName: Scan NGINX Image

- stage: Deploy
  displayName: Deploy NGINX
  dependsOn: Image_Scan
  condition: succeeded()
  jobs:
  - job: Deploy
    steps:
    - script: |
        docker run -d -p 80:80 nginx:alpine
      displayName: Run NGINX Container
